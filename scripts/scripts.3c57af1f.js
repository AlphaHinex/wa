"use strict";var avKey="ncucSqWquNS5qSBCNrqEhA8O",avSecret="d6cARxGcTwgyi0IGz7ss7LHp";AV.initialize(avKey,avSecret);var deps=["ngMaterial","ngRoute","ui.grid","ui.grid.exporter","ui.grid.moveColumns","ui.grid.pagination","ui.grid.pinning","ui.grid.resizeColumns"],app=angular.module("wa",deps),resourcesRoute=function(a){a.when("/",{controller:"loginCtrl",templateUrl:"views/login.html"}).when("/main",{templateUrl:"views/main.html"})};app.config(["$routeProvider",resourcesRoute]);var loginCtrl=function(a,b){AV.User.current()?b.url("/main"):a.needLogin=!0,a.imagePath="images/fall.368e657d.jpeg",a.login=function(){a.loging=!0,AV.User.logIn(a.uname,a.pwd,{success:function(){a.loginErr=!1,a.loging=!1,b.url("/main")},error:function(){console.log("failed"),a.loging=!1,a.uname="",a.pwd="",a.loginErr=!0}})}};loginCtrl.$inject=["$scope","$location"];var app=angular.module("wa");app.controller("loginCtrl",loginCtrl);var Case=AV.Object.extend("Case"),showTitle=function(a){var b=new AV.Query(AV.Role);b.equalTo("users",AV.User.current()),b.find({success:function(b){if(1===b.length){var c=b[0];a.role=c,a.roleName=c.getName(),"tx"===a.roleName&&(a.title="铁西区交通法庭")}else b.length>1&&(a.role=b[0],a.roleName=b[0].getName(),a.title="Wendy & Alpha")},error:function(a){console.debug(a)}})},allDefendants=function(){var a="人保财险, 平安保险, 天安保险, 中华联合, 人寿财险, 浙商保险, 华泰保险, 民安保险, 永安保险, 大地保险, 永诚保险, 都邦保险, 信达保险, 华安保险, 太平保险, 太平洋保险, 安华农业, 紫金财险, 渤海保险, 中银保险, 英大泰和保险";return a.split(/, +/g).map(function(a){return a})},createFilterFor=function(a){return function(b){return-1!==b.indexOf(a)}},resetCase=function(a,b){a.searchText="",b["case"]={initDate:new Date}},allStates=function(){return["判决","调解","和解","不予受理","咨询"]},refreshList=function(a){a.querying=!0,a.allCases=[];var b=a.nameFilter?"where plaintiff like '%"+a.nameFilter+"%' ":"",c="select * from Case "+b+"order by updatedAt desc limit 20";AV.Query.doCloudQuery(c,{success:function(b){var c=b.results;angular.forEach(c,function(b){a.allCases.push({id:b.id,createdAt:b.createdAt,updatedAt:b.updatedAt,initDate:b.attributes.initDate,finishDate:b.attributes.finishDate,plaintiff:b.attributes.plaintiff,defendants:b.attributes.defendants,details:b.attributes.details,state:b.attributes.state})}),a.querying=!1},error:function(b){a.querying=!1,console.dir(b)}})},getACL=function(a){var b=new AV.ACL;return b.setRoleReadAccess(a.role,!0),b.setRoleWriteAccess(a.role,!0),b},postSaveAndUpdate=function(a,b,c){resetCase(a,b),refreshList(a),a.submiting=!1,c.show(c.simple().content("保存成功!").position("right top").hideDelay(1500))},saveOrUpdateCallbacks=function(a,b,c,d){return{success:function(e){a.debug("Save case with objectId: "+e.id),postSaveAndUpdate(b,c,d)},error:function(b,c){a.debug("Save case failed cause: "+c.message)}}},saveOrUpdate=function(a,b,c,d){if(b.submiting=!0,c["case"].defendants||(c["case"].defendants=b.searchText),a.debug(c["case"]),c["case"].id){var e=new AV.Query(Case);e.get(c["case"].id,{success:function(e){e.set("initDate",c["case"].initDate),e.set("finishDate",c["case"].finishDate),e.set("plaintiff",c["case"].plaintiff),e.set("defendants",c["case"].defendants),e.set("details",c["case"].details),e.set("state",c["case"].state),e.setACL(getACL(c)),e.save(null,saveOrUpdateCallbacks(a,b,c,d))},error:function(b,c){a.debug("Update case failed cause: "+c.message)}})}else{var f=Case["new"](c["case"]);f.setACL(getACL(c)),f.save(null,saveOrUpdateCallbacks(a,b,c,d))}},setColor=function(a){var b=allStates(),c="font-weight: bold; color: ";switch(a){case b[0]:c+="red";break;case b[1]:c+="purple";break;case b[2]:c+="green";break;case b[3]:c+="blue";break;case b[4]:c+="brown"}return c},caseCtrl=function(a,b,c,d){a.logout=function(){AV.User.logOut(),d.url("/")},AV.User.current()?a.logged=!0:a.logout(),showTitle(a);var e=this;e.states=allStates(),e.allDefendants=allDefendants(),resetCase(e,a),refreshList(e),e.querySearch=function(a){return a?e.allDefendants.filter(createFilterFor(a)):e.allDefendants},a.save=function(){saveOrUpdate(c,e,a,b)},a.cancel=function(){resetCase(e,a),refreshList(e)},e.selectCase=function(b){a["case"]=b,e.searchText=a["case"].defendants},a.searchByName=function(){refreshList(e)},e.setColor=setColor};caseCtrl.$inject=["$scope","$mdToast","$log","$location"];var app=angular.module("wa");app.controller("caseCtrl",caseCtrl);var format=d3.time.format("%Y-%m-%d"),today=new Date,lastYear=new Date(today.getTime()-31536e6),color=function(a){var b=Math.ceil(a/.25);return"lv"+(b>4?4:b)},drawCalendar=function(){var a=750,b=140,c=13,d=d3.select(".cvph").append("svg").attr("width",a).attr("height",b).attr("class","cv").append("g").attr("transform","translate("+(a-53*c)/2+","+(b-7*c)/2+")");d.append("text").attr("transform","translate(-14,"+1.8*c+")").text("一"),d.append("text").attr("transform","translate(-14,"+3.8*c+")").text("三"),d.append("text").attr("transform","translate(-14,"+5.8*c+")").text("五");for(var e=53-d3.time.weekOfYear(lastYear),f=function(a){var b=a.getFullYear(),c=today.getFullYear(),d=d3.time.weekOfYear(a);return c>b?d=d-53+e:d+=e-1,d},g=lastYear.getFullYear(),h=1===lastYear.getDate()?lastYear.getMonth():lastYear.getMonth()+1,i=0;12>i;i++){var j=new Date(g,h+i,1),k=f(j)+(j.getDay()>0?1:0),l=j.getMonth()+1,m=l>9?l:"0"+l;d.append("text").attr("transform","translate("+c*k+", -5)").text(m)}var n=d.selectAll(".day").data(d3.time.days(lastYear,today)).enter().append("rect").attr("class","day").attr("width",c).attr("height",c).attr("x",function(a){return f(a)*c}).attr("y",function(a){return a.getDay()*c}).datum(format);n.append("title").text(function(a){return a})},dailyCount=function(a,b){var c=10,d=b.sc,e="";d.state&&(e+="and state = '"+d.state+"' "),(d.defendants||d.searchText)&&(e+="and defendants like '%"+(d.defendants?d.defendants:d.searchText)+"%' ");var f=new Date(a);f.setHours(0,0,0,0),f=f.toISOString();var g=new Date(a);g.setHours(23,59,59,999),g=g.toISOString();var h="select count(*) from Case where plaintiff > '' "+e+"and ((initDate <= date('"+g+"') and initDate >= date('"+f+"')) or (updatedAt >= date('"+f+"') and updatedAt <= date('"+g+"')))";AV.Query.doCloudQuery(h,{success:function(b){d3.selectAll("rect").data(d3.time.days(lastYear,today)).datum(format).filter(function(b){return b===a}).attr("class",function(){return"day "+color(b.count/c)}).select("title").text(function(a){return a+": "+b.count+" 件案子"})},error:function(a){console.dir(a)}})},refreshCalendarView=function(a){var b=new Date("2015-11-12");angular.forEach(d3.time.days(lastYear>b?lastYear:b,today),function(b){dailyCount(format(b),a)})},bindGridData=function(a,b){a.gridOptions.data=[],angular.forEach(b.results,function(b){a.gridOptions.data.push({initDateStr:format(b.attributes.initDate),updateDateStr:format(b.updatedAt),finishDateStr:"undefined"!=typeof b.attributes.finishDate?format(b.attributes.finishDate):"",plaintiff:b.attributes.plaintiff,defendants:b.attributes.defendants,details:b.attributes.details,state:b.attributes.state})})},refreshGridData=function(a){var b="",c=a.sc;if(c.fromDate){var d=format(c.fromDate)+"T00:00:00.000Z";b+="and (initDate >= date('"+d+"') or updatedAt >= date('"+d+"')) "}if(c.toDate){var e=format(c.toDate)+"T23:59:59.999Z";b+="and (initDate <= date('"+e+"') or updatedAt <= date('"+e+"')) "}c.state&&(b+="and state = '"+c.state+"' "),(c.defendants||c.searchText)&&(b+="and defendants like '%"+(c.defendants?c.defendants:c.searchText)+"%' ");var f="select * from Case where plaintiff > '' "+b;AV.Query.doCloudQuery(f,{success:function(b){bindGridData(a,b)},error:function(a){console.dir(a)}})},statisCtrl=function(a,b){b.setCurrentLang("zh-cn"),drawCalendar(),a.sc={},refreshCalendarView(a),a.gridOptions={columnDefs:[{name:"原告",field:"plaintiff",width:150},{name:"被告",field:"defendants",width:150},{name:"详细记录",field:"details"},{name:"立案日期",field:"initDateStr",width:100},{name:"更新日期",field:"updateDateStr",width:100},{name:"结案日期",field:"finishDateStr",width:100},{name:"状态",field:"state",width:100}],data:[],enableGridMenu:!0,enableSorting:!1,exporterCsvFilename:"statistic.csv",exporterMenuPdf:!1,paginationPageSizes:[25,50,75,100],paginationPageSize:25};var c=this;c.query=function(){refreshCalendarView(a),refreshGridData(a)},c.reset=function(){a.sc={},a.gridOptions.data=[],refreshCalendarView(a)}};statisCtrl.$inject=["$scope","i18nService"];var app=angular.module("wa");app.controller("statisCtrl",statisCtrl),angular.module("wa").run(["$templateCache",function(a){a.put("views/login.html",'<div layout="row" layout-align="center center" style="margin: 10px" ng-show="needLogin"> <md-card> <img ng-src="{{imagePath}}" class="md-card-image"> <form name="loginForm"> <md-content layout="column" layout-padding> <md-input-container layout> <label>用户名</label> <input ng-model="uname" required> </md-input-container> <md-input-container layout> <label>密码</label> <input ng-model="pwd" type="password" required> </md-input-container> <md-button layout class="md-raised md-primary" ng-show="loginForm.$valid" ng-click="login()">登录</md-button> <div ng-show="loginErr && uname===\'\'">登录失败</div> </md-content> </form> <md-progress-linear md-mode="query" ng-show="loging"></md-progress-linear> </md-card> </div>'),a.put("views/main.html",'<div ng-controller="caseCtrl as ctrl" ng-show="logged"> <md-toolbar layout="row" class="md-toolbar-tools md-whiteframe-z1"> <h1 flex>{{ title }}</h1> <img src="https://travis-ci.org/AlphaHinex/wa.svg?branch=master"> <md-button class="md-warn" ng-click="logout()">登出</md-button> </md-toolbar> <div layout="row" flex> <div layout="column" flex> <md-content class="md-padding"> <md-tabs md-dynamic-height> <md-tab id="case"> <md-tab-label>Case</md-tab-label> <md-tab-body> <md-card> <md-card-content layout-padding> <span class="md-title">案件信息</span> <form name="caseForm"> <div layout layout-sm> <label style="align-self: center">立案日期</label> <md-datepicker ng-model="case.initDate" se.inlaceholder="立案日期"></md-datepicker> <label style="align-self: center; padding-left: 20px">结案日期</label> <md-datepicker ng-model="case.finishDate" md-placeholder="结案日期"></md-datepicker> </div> <div layout layout-sm="column"> <md-input-container flex="40"> <label>原告</label> <input ng-model="case.plaintiff" required> </md-input-container> <md-autocomplete flex="60" md-floating-label="被告" md-search-text="ctrl.searchText" md-items="item in ctrl.querySearch(ctrl.searchText)" md-item-text="item" md-min-length="0" md-selected-item="case.defendants"> <md-item-template> <span md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{item}}</span> </md-item-template> <md-not-found> "{{ctrl.searchText}}" 尚不存在,请添加. </md-not-found> </md-autocomplete> </div> <md-input-container layout flex> <label>详细记录</label> <textarea ng-model="case.details" columns="1" md-maxlength="1500"></textarea> </md-input-container> <md-input-container> <label>状态</label> <md-select ng-model="case.state"> <md-option ng-repeat="state in ctrl.states" value="{{state}}"><span style="{{ctrl.setColor(state)}}">{{state}}</span></md-option> </md-select> </md-input-container> <div class="md-actions" layout="row"> <md-button class="md-raised md-primary" ng-click="save()" ng-show="roleName && caseForm.$valid" ng-disabled="ctrl.submiting">保存</md-button> <md-button class="md-raised" ng-click="cancel()">取消</md-button> </div> </form> </md-card-content> </md-card> <md-card> <md-card-content> <md-progress-linear md-mode="query" ng-show="ctrl.querying"></md-progress-linear> <span class="md-title">案件列表</span> <md-list> <md-list-item> <md-button class="md-raised md-primary" ng-click="searchByName()">检索</md-button> <md-input-container flex md-no-float> <input ng-model="ctrl.nameFilter" placeholder="按原告姓名模糊搜索"> </md-input-container> </md-list-item> <md-list-item class="md-3-line" ng-repeat="item in ctrl.allCases" ng-click="ctrl.selectCase(item)"> <div class="md-list-item-text" layout="column"> <h3>{{ item.plaintiff }} / {{ item.defendants }}</h3> <h4> <span style="{{ctrl.setColor(item.state)}}">{{ item.state }}</span> ( {{ item.initDate | date:\'yyyy-MM-dd\' }} ~ {{ item.finishDate | date:\'yyyy-MM-dd\' }} ) </h4> <p>{{ item.details }}</p> </div> </md-list-item> </md-list> </md-card-content> </md-card> </md-tab-body> </md-tab> <md-tab id="statistic"> <md-tab-label>Statistic</md-tab-label> <md-tab-body> <md-card layout-padding> <span class="md-title">案件统计</span> <div ng-controller="statisCtrl as sCtrl"> <div layout="column"> <div layout="row"> <md-button class="md-raised md-primary" ng-click="sCtrl.query()">检索</md-button> <md-button class="md-raised" ng-click="sCtrl.reset()">清空</md-button> </div> <div layout="row"> <label style="align-self: center">起始日期</label> <md-datepicker ng-model="sc.fromDate" md-placeholder="起始日期"></md-datepicker> <label style="align-self: center; padding-left: 20px">结束日期</label> <md-datepicker ng-model="sc.toDate" md-placeholder="结束日期"></md-datepicker> </div> <div layout="row"> <md-input-container> <label>状态</label> <md-select ng-model="sc.state"> <md-option ng-repeat="state in ctrl.states" value="{{state}}"><span style="{{ctrl.setColor(state)}}">{{state}}</span></md-option> </md-select> </md-input-container> <md-autocomplete flex md-floating-label="被告" md-search-text="sc.searchText" md-items="item in ctrl.querySearch(sc.searchText)" md-item-text="item" md-min-length="0" md-selected-item="sc.defendants"> <md-item-template> <span md-highlight-text="ctrl.searchText" md-highlight-flags="^i">{{item}}</span> </md-item-template> <md-not-found> "{{ctrl.searchText}}" 尚不存在,请添加. </md-not-found> </md-autocomplete> </div> </div> <div class="cvph"></div> <div ui-grid="gridOptions" ui-grid-exporter ui-grid-move-columns ui-grid-pagination ui-grid-pinning ui-grid-resize-columns class="grid"> </div> </div> </md-card> </md-tab-body> </md-tab> </md-tabs> </md-content> </div> </div> </div>')}]);