"use strict";var avKey="ncucSqWquNS5qSBCNrqEhA8O",avSecret="d6cARxGcTwgyi0IGz7ss7LHp";AV.initialize(avKey,avSecret);var deps=["ngMaterial","ui.grid","ui.grid.exporter","ui.grid.moveColumns","ui.grid.pagination","ui.grid.pinning","ui.grid.resizeColumns"];angular.module("wa",deps);var Case=AV.Object.extend("Case"),allDefendants=function(){var a="人保财险, 平安保险, 天安保险, 中华联合, 人寿财险, 浙商保险, 华泰保险, 民安保险, 永安保险, 大地保险, 永诚保险, 都邦保险, 信达保险, 华安保险, 太平保险, 太平洋保险, 安华农业, 紫金财险, 渤海保险, 中银保险, 英大泰和保险";return a.split(/, +/g).map(function(a){return a})},createFilterFor=function(a){return function(b){return-1!==b.indexOf(a)}},resetCase=function(a,b){a.searchText="",b["case"]={initDate:new Date}},allStates=function(){return["判决","调解","和解","不予受理","咨询"]},refreshList=function(a){a.querying=!0,a.allCases=[];var b=a.nameFilter?"where plaintiff like '%"+a.nameFilter+"%' ":"",c="select * from Case "+b+"order by updatedAt desc limit 20";AV.Query.doCloudQuery(c,{success:function(b){var c=b.results;angular.forEach(c,function(b){a.allCases.push({id:b.id,createdAt:b.createdAt,updatedAt:b.updatedAt,initDate:b.attributes.initDate,finishDate:b.attributes.finishDate,plaintiff:b.attributes.plaintiff,defendants:b.attributes.defendants,details:b.attributes.details,state:b.attributes.state})}),a.querying=!1},error:function(b){a.querying=!1,console.dir(b)}})},postSaveAndUpdate=function(a,b,c){resetCase(a,b),refreshList(a),a.submiting=!1,c.show(c.simple().content("保存成功!").position("right top").hideDelay(1500))},saveOrUpdateCallbacks=function(a,b,c,d){return{success:function(e){a.debug("Save case with objectId: "+e.id),postSaveAndUpdate(b,c,d)},error:function(b,c){a.debug("Save case failed cause: "+c.message)}}},saveOrUpdate=function(a,b,c,d){if(b.submiting=!0,c["case"].defendants||(c["case"].defendants=b.searchText),a.debug(c["case"]),c["case"].id){var e=new AV.Query(Case);e.get(c["case"].id,{success:function(e){e.set("initDate",c["case"].initDate),e.set("finishDate",c["case"].finishDate),e.set("plaintiff",c["case"].plaintiff),e.set("defendants",c["case"].defendants),e.set("details",c["case"].details),e.set("state",c["case"].state),e.save(null,saveOrUpdateCallbacks(a,b,c,d))},error:function(b,c){a.debug("Update case failed cause: "+c.message)}})}else{var f=Case["new"](c["case"]);f.save(null,saveOrUpdateCallbacks(a,b,c,d))}},setColor=function(a){var b=allStates(),c="font-weight: bold; color: ";switch(a){case b[0]:c+="red";break;case b[1]:c+="purple";break;case b[2]:c+="green";break;case b[3]:c+="blue";break;case b[4]:c+="brown"}return c},caseCtrl=function(a,b,c){var d=this;d.states=allStates(),d.allDefendants=allDefendants(),resetCase(d,a),refreshList(d),d.querySearch=function(a){return a?d.allDefendants.filter(createFilterFor(a)):d.allDefendants},a.save=function(){saveOrUpdate(c,d,a,b)},a.cancel=function(){resetCase(d,a),refreshList(d)},d.selectCase=function(b){a["case"]=b,d.searchText=a["case"].defendants},a.searchByName=function(){refreshList(d)},d.setColor=setColor};caseCtrl.$inject=["$scope","$mdToast","$log"];var app=angular.module("wa");app.controller("caseCtrl",caseCtrl);var width=750,height=140,cellSize=13,format=d3.time.format("%Y-%m-%d"),color=function(a){var b=Math.ceil(a/.25);return"lv"+(b>4?4:b)},svg=d3.select(".cv").append("svg").attr("width",width).attr("height",height).attr("class","cv").append("g").attr("transform","translate("+(width-53*cellSize)/2+","+(height-7*cellSize)/2+")");svg.append("text").attr("transform","translate(-14,"+1.8*cellSize+")").text("一"),svg.append("text").attr("transform","translate(-14,"+3.8*cellSize+")").text("三"),svg.append("text").attr("transform","translate(-14,"+5.8*cellSize+")").text("五");for(var today=new Date,lastYear=new Date(today.getTime()-31536e6),shiftWeeks=53-d3.time.weekOfYear(lastYear),shiftWeek=function(a){var b=a.getFullYear(),c=today.getFullYear(),d=d3.time.weekOfYear(a);return c>b?d=d-53+shiftWeeks:d+=shiftWeeks-1,d},startYear=lastYear.getFullYear(),startMonth=1===lastYear.getDate()?lastYear.getMonth():lastYear.getMonth()+1,i=0;12>i;i++){var s=new Date(startYear,startMonth+i,1),w=shiftWeek(s)+(s.getDay()>0?1:0),m=s.getMonth()+1,l=m>9?m:"0"+m;svg.append("text").attr("transform","translate("+cellSize*w+", -5)").text(l)}var rect=svg.selectAll(".day").data(d3.time.days(lastYear,today)).enter().append("rect").attr("class","day").attr("width",cellSize).attr("height",cellSize).attr("x",function(a){return shiftWeek(a)*cellSize}).attr("y",function(a){return a.getDay()*cellSize}).datum(format);rect.append("title").text(function(a){return a});var dailyCount=function(a){var b=10,c=new Date(a);c.setHours(0,0,0,0),c=c.toISOString();var d=new Date(a);d.setHours(23,59,59,999),d=d.toISOString();var e="select count(*) from Case where plaintiff > '' and ((initDate <= date('"+d+"') and initDate >= date('"+c+"')) or (updatedAt >= date('"+c+"') and updatedAt <= date('"+d+"')))";AV.Query.doCloudQuery(e,{success:function(c){d3.selectAll("rect").data(d3.time.days(lastYear,today)).datum(format).filter(function(b){return b===a}).attr("class",function(){return"day "+color(c.count/b)}).select("title").text(function(a){return a+": "+c.count+" 件案子"})},error:function(a){console.dir(a)}})},begining=new Date("2015-11-12");angular.forEach(d3.time.days(lastYear>begining?lastYear:begining,today),function(a){dailyCount(format(a))});var refreshGridData=function(a,b){angular.forEach(b.results,function(b){a.gridOptions.data.push({initDateStr:format(b.attributes.initDate),updateDateStr:format(b.updatedAt),finishDateStr:"undefined"!=typeof b.attributes.finishDate?format(b.attributes.finishDate):"",plaintiff:b.attributes.plaintiff,defendants:b.attributes.defendants,details:b.attributes.details,state:b.attributes.state})})},initGridData=function(a){var b="select * from Case ";AV.Query.doCloudQuery(b,{success:function(b){refreshGridData(a,b)},error:function(a){console.dir(a)}})},statisCtrl=function(a,b){b.setCurrentLang("zh-cn"),a.gridOptions={columnDefs:[{name:"原告",field:"plaintiff",width:150},{name:"被告",field:"defendants",width:150},{name:"详细记录",field:"details"},{name:"立案日期",field:"initDateStr",width:100},{name:"更新日期",field:"updateDateStr",width:100},{name:"结案日期",field:"finishDateStr",width:100},{name:"状态",field:"state",width:100}],data:[],enableGridMenu:!0,enableSorting:!1,exporterCsvFilename:"statistic.csv",exporterMenuPdf:!1,paginationPageSizes:[25,50,75,100],paginationPageSize:25},initGridData(a)};statisCtrl.$inject=["$scope","i18nService"];var app=angular.module("wa");app.controller("statisCtrl",statisCtrl);